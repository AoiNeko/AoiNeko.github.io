<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="langley, liangli171@gmail.com"><title>mqtt了解 · AoiNeko</title><meta name="description" content="背景公司的停车软件要与停车app共享数据，而停车场中经常出现断电或者网络不稳定，换4g卡当热点又有可能地下停车场的原因信号不好，导致数据缺失。于是在车场系统重构演进过程中，项目组决定在RESTful接口上使用MQTT做辅助的数据传输。
MQTTMQ Telementry Transport 是一个基"><meta name="keywords" content="Hexo,Java"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><e class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/mylogo.jpg" style="width:127px;"><h3 title=""><a href="/">AoiNeko</a></h3><div class="description"><p>一些个记录</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"></a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Hexo&#65281;</a></div></div></e><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>mqtt了解</a></h3></div><div class="post-content"><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>公司的停车软件要与停车app共享数据，而停车场中经常出现断电或者网络不稳定，换4g卡当热点又有可能地下停车场的原因信号不好，导致数据缺失。于是在车场系统重构演进过程中，项目组决定在RESTful接口上使用MQTT做辅助的数据传输。</p>
<h3 id="MQTT"><a href="#MQTT" class="headerlink" title="MQTT"></a>MQTT</h3><p>MQ Telementry Transport 是一个基于代理(broker-based)的轻量级发布/订阅型消息协议。协议的设计特性使其适合在在受限制环境下使用（物联网，嵌入式设备，网络资费昂贵 ，带宽狭窄，或者网络不可靠的情况下）。</p>
<h4 id="协议说明地址"><a href="#协议说明地址" class="headerlink" title="协议说明地址"></a>协议说明地址</h4><p><a href="http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html" target="_blank" rel="external">http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/mqtt-v3r1.html</a></p>
<h4 id="fixed-header"><a href="#fixed-header" class="headerlink" title="fixed header"></a>fixed header</h4><p>mqtt的固定头，即不管消息什么类型必须有的头内容，结构如图：</p>
<p><img src="http://oakgltq5l.bkt.clouddn.com/mqttheader.png" alt="mqttheader" title="header"></p>
<p>RETAIN： 代表是否存储在代理位置<br>Qos LEVEL： PUBLISH消息的级别<br> 00代表不存储 at most once ， 发送了就不管了，对那些有没有都无所谓的消息可以使用这种级别<br> 01 at least once 保证消息可以达到<br> 10 exactly once  保证收到一次消息<br>DUP: 标志是否是重复发送的消息<br>Remaining Length： 用来描述剩下来的数据长度，包括variable header和payload的内容</p>
<p><img src="http://oakgltq5l.bkt.clouddn.com/mqttRemainLength.png" alt="remainlength" title="remain length"></p>
<p>byte中0-6记录值，第8个bit代表是否还有下一个byte， 相当于128进制，所以最大就是268 435 455 (256 MB).</p>
<h4 id="variable-header"><a href="#variable-header" class="headerlink" title="variable header"></a>variable header</h4><p>根据消息类型，部分消息带有变量头，位于fixed header 和payload之间。包含 协议名称，协议版本，链接标志位，响应码，topic名称等等。估计在实现协议客户端或者服务端的时候要根据消息的类型，获取需要位置的标志来进行处理吧。暂时先不做深度的研究，下次把broker的实现moqutte源码学习一下， 就能了解网络协议的处理过程了。</p>
<h4 id="message-Type"><a href="#message-Type" class="headerlink" title="message Type"></a>message Type</h4><p>下面是mqtt中的消息类型，从客户端连接，订阅主题，发布消息，心跳保持，到断开链接等等</p>
<p><img src="http://oakgltq5l.bkt.clouddn.com/mqttmessagetype.png" alt="messagesPic"></p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>mqtt是基于tcp的网络协议，轻量级等特性用来熟悉网络编程还挺适合的，看了协议的详细才真正开始知道如何在网络中光速传递的信息是如何由比特流转化成本地计算机能理解的字节再转成上层应用的对象，最后展示给用户或者记录到存储中的。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-08-02</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/08/02/mqtt了解/,AoiNeko,mqtt了解,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/08/15/redis分布式锁应用/" title="redis分布式锁应用" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/07/08/对象状态的位操作/" title="对象状态的位操作" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>