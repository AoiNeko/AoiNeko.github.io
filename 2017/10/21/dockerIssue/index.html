<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="langley, liangli171@gmail.com"><title>一次docker环境遇到的问题 · AoiNeko</title><meta name="description" content="起因测试环境因为反复不断构建docker容器，导致硬盘每过一段时间就会占满。用docker文档中的方法 将/var/lib/docker目录移动到 挂载的硬盘上然后建软链接指向新目录。然后别人在使用jenkins重新创建镜像并删除历史容器时就报错了。
现象docker rm -v mq-backen"><meta name="keywords" content="Hexo,Java"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><e class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/mylogo.jpg" style="width:127px;"><h3 title=""><a href="/">AoiNeko</a></h3><div class="description"><p>一些个记录</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"></a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Hexo&#65281;</a></div></div></e><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>一次docker环境遇到的问题</a></h3></div><div class="post-content"><h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>测试环境因为反复不断构建docker容器，导致硬盘每过一段时间就会占满。用docker文档中的方法 将/var/lib/docker目录移动到 挂载的硬盘上然后建软链接指向新目录。然后别人在使用jenkins重新创建镜像并删除历史容器时就报错了。</p>
<h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><p>docker rm -v mq-backend<br>Error response from daemon: driver “overlay” failed to remove root filesystem for 2b0dbb0978af2a95f55afb23727a1a69bbb943ee2c08eff68ed6426f64ada870: remove /data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/merged: device or resource busy</p>
<h3 id="查询进程"><a href="#查询进程" class="headerlink" title="查询进程"></a>查询进程</h3><p>[apms@iZwz9g3u73g9o288clbphfZ ~]$ sudo find /proc/*/mounts | xargs  grep -E e13396b62d7345838e<br>grep: /proc/10305/mounts: No such file or directory<br>/proc/12910/mounts:overlay /data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/merged overlay rw,relatime,lowerdir=/data/docker/sys/lib/docker/overlay/65dd18c83c91a528cfd8493157d3d9abd76b17a84ae7801019daf8e64e15e6f6/root,upperdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/upper,workdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/work 0 0<br>/proc/12937/mounts:overlay /data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/merged overlay rw,relatime,lowerdir=/data/docker/sys/lib/docker/overlay/65dd18c83c91a528cfd8493157d3d9abd76b17a84ae7801019daf8e64e15e6f6/root,upperdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/upper,workdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/work 0 0<br>/proc/15727/mounts:overlay /data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/merged overlay rw,relatime,lowerdir=/data/docker/sys/lib/docker/overlay/65dd18c83c91a528cfd8493157d3d9abd76b17a84ae7801019daf8e64e15e6f6/root,upperdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/upper,workdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/work 0 0<br>/proc/15751/mounts:overlay /data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/merged overlay rw,relatime,lowerdir=/data/docker/sys/lib/docker/overlay/65dd18c83c91a528cfd8493157d3d9abd76b17a84ae7801019daf8e64e15e6f6/root,upperdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/upper,workdir=/data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/work 0 0<br>grep: /proc/26598/mounts: Invalid argument</p>
<p>[apms@iZwz9g3u73g9o288clbphfZ ~]$ sudo find /proc/*/mounts | xargs  grep -E 2b0dbb0978af2a95f55af<br>/proc/12910/mounts:shm /data/docker/sys/lib/docker/containers/2b0dbb0978af2a95f55afb23727a1a69bbb943ee2c08eff68ed6426f64ada870/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k 0 0<br>/proc/12937/mounts:shm /data/docker/sys/lib/docker/containers/2b0dbb0978af2a95f55afb23727a1a69bbb943ee2c08eff68ed6426f64ada870/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k 0 0<br>grep: /proc/14249/mounts: No such file or directory<br>/proc/15727/mounts:shm /data/docker/sys/lib/docker/containers/2b0dbb0978af2a95f55afb23727a1a69bbb943ee2c08eff68ed6426f64ada870/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k 0 0<br>/proc/15751/mounts:shm /data/docker/sys/lib/docker/containers/2b0dbb0978af2a95f55afb23727a1a69bbb943ee2c08eff68ed6426f64ada870/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=65536k 0 0<br>grep: /proc/26598/mounts: Invalid argument</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>docker在删除 /data/docker/sys/lib/docker/overlay/e13396b62d7345838eceb449e1a1aa4cb5be7f81fb1c7fb10939e903356ac2d1/merged目录时，被其他进程阻止了因为这个目录也在被其他容器使用。<br>这个时候试着kill -9 12910 12937 15727 15751  remove这个容器的device busy错误就没了，同时另外的3个容器也被kill掉停止。</p>
<h3 id="namespaces"><a href="#namespaces" class="headerlink" title="namespaces"></a>namespaces</h3><p>作为容器的基础即是linux的 namespaces机制，可以为一组进程独立隔离出虚拟的系统资源。这组独立的资源包括进程id，hostname，用户id，网络链接，IPC(inter-process communication)，文件系统。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>挂载点泄露其实是linux某些发行版的内核bug，删除文件夹失败因其挂载在其他mount namespace当中。(A directory removal has failed because this directory is mounted on in some other mount namespace.)</p>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><ol>
<li><p>在docker.service中设置MountFlags=slave参数， 是容器重启时每次获取新的命名空间</p>
</li>
<li><p>升级内核， aliyun测试在他们的页面上有提交经过验证的内核升级脚本<br><a href="https://yq.aliyun.com/ask/47238" target="_blank" rel="external">https://yq.aliyun.com/ask/47238</a></p>
</li>
</ol>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><p>Docker issue: <a href="https://github.com/moby/moby/issues/27381" target="_blank" rel="external">https://github.com/moby/moby/issues/27381</a><br><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1357121" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1357121</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-10-21</span><i class="fa fa-tag"></i><a href="/tags/docker-devOps/" title="docker,devOps" class="tag">docker,devOps </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/10/21/dockerIssue/,AoiNeko,一次docker环境遇到的问题,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/01/07/kafka-setup/" title="kafka安装记录" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/10/21/docker笔记/" title="docker笔记" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>